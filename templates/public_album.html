{% extends 'layout.html' %}
{% block title %}{{ album.title }} – {{ site_title }}{% endblock %}
{% block header_class %}hide{% endblock %}

{% block content %}
{% if locked %}
  <section class="auth-wrap">
    <div class="auth-card">
      <h1 class="auth-title serif">{{ album.title }}</h1>
      {% if error %}<div class="auth-alert" role="alert">Incorrect password. Please try again.</div>{% endif %}
      <form action="/s/{{ share.slug }}/unlock" method="post" class="auth-form" novalidate>
        <label class="auth-label" for="password">Password</label>
        <input id="password" name="password" type="password" required class="auth-input" placeholder="••••••••" />
        <button class="auth-btn" type="submit">Unlock</button>
      </form>
    </div>
  </section>
{% else %}

  {# احرص على وجود القيم حتى لو لم يرسلها الراوتر (منع 500) #}
  {% set hero = hero|default(None) %}
  {% set gallery_assets = gallery_assets|default(assets|default([])) %}
  {% set gallery_videos = gallery_videos|default([]) %}

  {# الغلاف (اختياري) #}
  {% if hero %}
    {% include 'partials/_hero.html' %}
  {% endif %}

  {# شبكة الصور — يعتمد على partial الذي يقرأ gallery_assets #}
  {% include 'partials/_gallery.html' %}

  {# ====== شبكة الفيديوهات (سريعة – بلوك منفصل) ====== #}
  {% if gallery_videos and gallery_videos|length > 0 %}
    <section class="gallery-videos grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mt-8">
      {% for v in gallery_videos %}
        <div class="aspect-video w-full rounded-lg overflow-hidden bg-black">
          <iframe
            class="w-full h-full"
            src="{{ build_embed_url(v.provider, v.video_id, v.vimeo_hash if v.provider == 'vimeo' else None) }}"

            title="{{ v.title or 'Video' }}"
            loading="lazy"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            referrerpolicy="strict-origin-when-cross-origin"
            allowfullscreen>
          </iframe>
        </div>
      {% endfor %}
    </section>
  {% endif %}

  {# Lightbox: يظهر عند الضغط على صورة #}
  <div id="lb" class="lb" hidden aria-modal="true" role="dialog">
    <button class="lb-close" type="button" aria-label="Close">✕</button>

    <div class="lb-stage">
      <img id="lb-img" alt="" />
    </div>

    <div class="lb-toolbar" role="toolbar" aria-label="Image actions">
      <button class="lb-btn" data-act="prev" aria-label="Previous">⟵</button>
      <button class="lb-btn" data-act="next" aria-label="Next">⟶</button>
      <div class="lb-spacer"></div>
      <button class="lb-btn" data-act="download" aria-label="Download">⬇️</button>
      <button class="lb-btn" data-act="open" aria-label="Open in new tab">🔗</button>
      <button class="lb-btn" data-act="copy" aria-label="Copy link">📋</button>
    </div>
  </div>

{% endif %}
{% endblock %}

{% block scripts_extra %}
  {{ super() }}
  <script>
    // Lightbox بسيط
    (function () {
      const lb = document.getElementById('lb');
      if (!lb) return;

      const imgEl = document.getElementById('lb-img');
      const closeBtn = lb.querySelector('.lb-close');
      const toolbar = lb.querySelector('.lb-toolbar');

      let links = [];
      function collectLinks() {
        links = Array.from(document.querySelectorAll('#gallery a[data-full]'));
      }
      collectLinks();

      let idx = -1;

      function openAt(i) {
        if (i < 0 || i >= links.length) return;
        idx = i;
        const href = links[idx].dataset.full || links[idx].getAttribute('href');
        imgEl.src = href;
        imgEl.alt = links[idx].dataset.name || '';
        lb.hidden = false;
        document.body.style.overflow = 'hidden';
        toolbar.querySelector('[data-act="prev"]').disabled = (idx <= 0);
        toolbar.querySelector('[data-act="next"]').disabled = (idx >= links.length - 1);
        // preload next
        const pre = new Image();
        if (idx + 1 < links.length) pre.src = links[idx + 1].dataset.full || links[idx + 1].href;
      }
      function close() { lb.hidden = true; imgEl.src = ''; document.body.style.overflow = ''; }
      function next()  { if (idx < links.length - 1) openAt(idx + 1); }
      function prev()  { if (idx > 0) openAt(idx - 1); }

      // فتح عند الضغط على صورة
      document.addEventListener('click', (e) => {
        const a = e.target.closest('#gallery a[data-full]');
        if (!a) return;
        e.preventDefault();
        collectLinks();
        const i = links.indexOf(a);
        if (i !== -1) openAt(i);
      });

      // أزرار الشريط
      toolbar.addEventListener('click', async (e) => {
        const b = e.target.closest('.lb-btn'); if (!b) return;
        const act = b.dataset.act, url = imgEl.src;
        if (act === 'next') return next();
        if (act === 'prev') return prev();
        try {
          if (act === 'download') { const a = document.createElement('a'); a.href = url; a.download = ''; document.body.appendChild(a); a.click(); a.remove(); }
          else if (act === 'open') { window.open(url, '_blank', 'noopener'); }
          else if (act === 'copy') { await navigator.clipboard.writeText(url); const old=b.textContent; b.textContent='✅'; setTimeout(()=>b.textContent=old,900); }
        } catch(err){ console.warn(err); alert('Action failed'); }
      });

      // إغلاق
      closeBtn.addEventListener('click', close);
      lb.addEventListener('click', (e) => { if (e.target === lb) close(); });
      document.addEventListener('keydown', (e) => {
        if (lb.hidden) return;
        if (e.key==='Escape') close();
        if (e.key==='ArrowRight') next();
        if (e.key==='ArrowLeft') prev();
      });
    })();
  </script>
{% endblock %}
