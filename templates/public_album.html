{% extends 'layout.html' %}
{% block title %}{{ album.title }} â€“ {{ site_title }}{% endblock %}
{% block header_class %}hide{% endblock %}

{% block content %}
{% if locked %}
  <section class="auth-wrap">
    <div class="auth-card">
      <h1 class="auth-title serif">{{ album.title }}</h1>
      {% if error %}<div class="auth-alert" role="alert">Incorrect password. Please try again.</div>{% endif %}
      <form action="/s/{{ share.slug }}/unlock" method="post" class="auth-form" novalidate>
        <label class="auth-label" for="password">Password</label>
        <input id="password" name="password" type="password" required class="auth-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
        <button class="auth-btn" type="submit">Unlock</button>
      </form>
    </div>
  </section>
{% else %}

  {# Ø§Ø­Ø±Øµ Ø¹Ù„Ù‰ ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù‚ÙŠÙ… Ø­ØªÙ‰ Ù„Ùˆ Ù„Ù… ÙŠØ±Ø³Ù„Ù‡Ø§ Ø§Ù„Ø±Ø§ÙˆØªØ± (Ù…Ù†Ø¹ 500) #}
  {% set hero = hero|default(None) %}
  {% set gallery_assets = gallery_assets|default(assets|default([])) %}

  {# Ø§Ù„ØºÙ„Ø§Ù (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) #}
  {% if hero %}
    {% include 'partials/_hero.html' %}
  {% endif %}

  {# Ø´Ø¨ÙƒØ© Ø§Ù„ØµÙˆØ± â€” ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ partial Ø§Ù„Ø°ÙŠ ÙŠÙ‚Ø±Ø£ gallery_assets #}
  {% include 'partials/_gallery.html' %}

  {# Lightbox: ÙŠØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ ØµÙˆØ±Ø© #}
  <div id="lb" class="lb" hidden aria-modal="true" role="dialog">
    <button class="lb-close" type="button" aria-label="Close">âœ•</button>

    <div class="lb-stage">
      <img id="lb-img" alt="" />
    </div>

    <div class="lb-toolbar" role="toolbar" aria-label="Image actions">
      <button class="lb-btn" data-act="prev" aria-label="Previous">âŸµ</button>
      <button class="lb-btn" data-act="next" aria-label="Next">âŸ¶</button>
      <div class="lb-spacer"></div>
      <button class="lb-btn" data-act="download" aria-label="Download">â¬‡ï¸</button>
      <button class="lb-btn" data-act="open" aria-label="Open in new tab">ğŸ”—</button>
      <button class="lb-btn" data-act="copy" aria-label="Copy link">ğŸ“‹</button>
    </div>
  </div>

{% endif %}
{% endblock %}

{% block scripts_extra %}
  {{ super() }}
  <script>
    // Lightbox Ø¨Ø³ÙŠØ·
    (function () {
      const lb = document.getElementById('lb');
      if (!lb) return;

      const imgEl = document.getElementById('lb-img');
      const closeBtn = lb.querySelector('.lb-close');
      const toolbar = lb.querySelector('.lb-toolbar');

      let links = [];
      function collectLinks() {
        links = Array.from(document.querySelectorAll('#gallery a[data-full]'));
      }
      collectLinks();

      let idx = -1;

      function openAt(i) {
        if (i < 0 || i >= links.length) return;
        idx = i;
        const href = links[idx].dataset.full || links[idx].getAttribute('href');
        imgEl.src = href;
        imgEl.alt = links[idx].dataset.name || '';
        lb.hidden = false;
        document.body.style.overflow = 'hidden';
        toolbar.querySelector('[data-act="prev"]').disabled = (idx <= 0);
        toolbar.querySelector('[data-act="next"]').disabled = (idx >= links.length - 1);
        // preload next
        const pre = new Image();
        if (idx + 1 < links.length) pre.src = links[idx + 1].dataset.full || links[idx + 1].href;
      }
      function close() { lb.hidden = true; imgEl.src = ''; document.body.style.overflow = ''; }
      function next()  { if (idx < links.length - 1) openAt(idx + 1); }
      function prev()  { if (idx > 0) openAt(idx - 1); }

      // ÙØªØ­ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ ØµÙˆØ±Ø©
      document.addEventListener('click', (e) => {
        const a = e.target.closest('#gallery a[data-full]');
        if (!a) return;
        e.preventDefault();
        collectLinks();
        const i = links.indexOf(a);
        if (i !== -1) openAt(i);
      });

      // Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø´Ø±ÙŠØ·
      toolbar.addEventListener('click', async (e) => {
        const b = e.target.closest('.lb-btn'); if (!b) return;
        const act = b.dataset.act, url = imgEl.src;
        if (act === 'next') return next();
        if (act === 'prev') return prev();
        try {
          if (act === 'download') { const a = document.createElement('a'); a.href = url; a.download = ''; document.body.appendChild(a); a.click(); a.remove(); }
          else if (act === 'open') { window.open(url, '_blank', 'noopener'); }
          else if (act === 'copy') { await navigator.clipboard.writeText(url); const old=b.textContent; b.textContent='âœ…'; setTimeout(()=>b.textContent=old,900); }
        } catch(err){ console.warn(err); alert('Action failed'); }
      });

      // Ø¥ØºÙ„Ø§Ù‚
      closeBtn.addEventListener('click', close);
      lb.addEventListener('click', (e) => { if (e.target === lb) close(); });
      document.addEventListener('keydown', (e) => {
        if (lb.hidden) return;
        if (e.key==='Escape') close();
        if (e.key==='ArrowRight') next();
        if (e.key==='ArrowLeft') prev();
      });
    })();
  </script>
{% endblock %}
